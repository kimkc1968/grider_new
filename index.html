<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeoX ì§ì› ID ë° í˜„í™© ëŒ€ì‹œë³´ë“œ (í¸ì§‘ ë° ì´ë ¥ ê´€ë¦¬)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
        }
        /* Custom styles for status badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        .dashboard-card {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .data-row {
            transition: background-color 0.15s ease-in-out;
        }
        .data-row:not(.editing):hover {
            opacity: 0.95;
            /* Tailwind classes below will be used by JavaScript for dynamic hover colors */
        }
        .history-row {
            display: none;
            background-color: #f7f9fb;
            border-bottom: 2px solid #e2e8f0;
        }
        .history-list li {
            padding: 0.5rem 0;
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* Input/Select styling for edit mode */
        .edit-input, .edit-select {
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            width: 100%;
            box-sizing: border-box;
            background-color: white;
        }
        .data-action {
             /* Makes the cell content clickable for history, but not the buttons */
             cursor: pointer;
        }
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body class="p-4 sm:p-10 flex justify-center">
    <div class="w-full lg:max-w-6xl bg-white rounded-2xl dashboard-card overflow-hidden">
        
        <!-- Header Section -->
        <header class="p-6 sm:p-8 bg-white border-b border-gray-100 flex justify-between items-start flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">ë¶€ì‚°CXì„¼í„° ì§ì› LeoX ID ë° í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-md text-gray-500 mt-2">ì§ì› í˜„í™©ì„ ì§ì ‘ ìˆ˜ì •í•˜ê³  ë³€ê²½ ì´ë ¥ì„ ê´€ë¦¬í•´ë³´ì„¸ìš”. (ì•„ì´ë””ëŠ” ë³€ê²½ ë¶ˆê°€)</p>
            </div>
            <!-- Control Buttons Group -->
            <div class="flex flex-col sm:flex-row gap-3 flex-shrink-0">
                <!-- New ID Generation Button (Initially Disabled) -->
                <button id="addNewIdBtn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg shadow-none opacity-50 cursor-not-allowed transition duration-150 flex items-center justify-center space-x-2" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span>ì‹ ê·œ ID ìƒì„±</span>
                </button>
                
                <!-- Edit Mode Toggle Button -->
                <button id="toggleEditModeBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-red-600 transition duration-150 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1h2V3a1 1 0 00-1-1zm5.66 4.34a1 1 0 011.414 0l1.414 1.414a1 1 0 010 1.414L10.414 17h-1.414l-1.414 1.414a1 1 0 01-1.414 0L4.34 17.414a1 1 0 010-1.414l7.95-7.95-1.414-1.414 1.414-1.414L15 6.414zM10 13a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                    <span id="editModeStatus">ìˆ˜ì • ë¹„í™œì„±í™”</span>
                </button>
            </div>
        </header>

        <!-- Filter Controls Section -->
        <div class="p-6 sm:p-8 border-b border-gray-100 bg-gray-50 flex flex-col md:flex-row gap-4 items-center">
            <h2 class="text-lg font-semibold text-gray-700 md:w-1/4">ë°ì´í„° í•„í„°ë§</h2>
            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-3/4">
                <!-- Status Filter Buttons (Replaced Select) -->
                <div id="statusFilterButtons" class="flex items-center gap-2 flex-grow flex-wrap">
                    <label class="text-sm font-medium text-gray-700 whitespace-nowrap">ê·¼ë¬´:</label>
                    <button data-status="ì „ì²´" class="status-btn bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-150">ì „ì²´ ë³´ê¸°</button>
                    <button data-status="ê·¼ë¬´ì¤‘" class="status-btn bg-gray-200 text-gray-700 hover:bg-gray-300 py-1 px-3 rounded-lg transition duration-150">ğŸŸ¢ ê·¼ë¬´ì¤‘</button>
                    <button data-status="í‡´ì‚¬" class="status-btn bg-gray-200 text-gray-700 hover:bg-gray-300 py-1 px-3 rounded-lg transition duration-150">ğŸ”´ í‡´ì‚¬</button>
                    <button data-status="ì‹ ì²­ ì—†ìŒ" class="status-btn bg-gray-200 text-gray-700 hover:bg-gray-300 py-1 px-3 rounded-lg transition duration-150">âš«ï¸ ì‹ ì²­ ì—†ìŒ</button>
                    <!-- Hidden input to hold current filter value -->
                    <input type="hidden" id="statusFilter" value="ì „ì²´"> 
                </div>
                <div class="flex-grow">
                    <input type="text" id="searchFilter" placeholder="ì´ë¦„ ë˜ëŠ” IDë¡œ ê²€ìƒ‰..." class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full transition duration-150">
                </div>
            </div>
        </div>

        <!-- Employee Status Table -->
        <div class="overflow-x-auto p-4">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50">
                    <tr>
                        <th class="px-6 py-4 text-center text-xs font-bold text-blue-700 uppercase tracking-wider rounded-tl-xl">ì•„ì´ë””</th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-blue-700 uppercase tracking-wider">ì´ë¦„</th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-blue-700 uppercase tracking-wider">ê·¼ë¬´ì—¬ë¶€</th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-blue-700 uppercase tracking-wider">LeoX ìƒíƒœ</th>
                        <th class="px-3 py-4 text-center text-xs font-bold text-blue-700 uppercase tracking-wider w-24">ì•¡ì…˜ / ì´ë ¥</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody" class="divide-y divide-gray-100">
                    <!-- Dynamic Rows and History Rows will be inserted here -->
                </tbody>
            </table>
            <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ -->
            <div id="noResults" class="hidden text-center p-8 text-lg text-gray-500">
                ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <!-- Footer Section -->
        <footer class="p-6 text-sm text-gray-500 text-center border-t border-gray-100 bg-gray-50 rounded-b-2xl">
            ë³€ê²½ ì´ë ¥ ê¸°ëŠ¥ì„ í¬í•¨í•˜ì—¬ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
        </footer>
    </div>
    
    <!-- Password Input Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ìˆ˜ì • ëª¨ë“œ í™œì„±í™”</h3>
            <p class="text-gray-600 mb-4">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ìˆ˜ì • ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì„¸ìš”.</p>
            <input type="password" id="passwordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 edit-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <div class="flex justify-end space-x-2">
                <button id="cancelPasswordBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-150">ì·¨ì†Œ</button>
                <button id="submitPasswordBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">í™•ì¸</button>
            </div>
            <p id="passwordError" class="text-red-500 text-sm mt-3 hidden">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
            <h3 class="text-lg font-bold mb-3 text-red-700">ID ì‚­ì œ í™•ì¸</h3>
            <p class="text-gray-600 mb-4 text-sm" id="deleteConfirmMessage"></p>
            <div class="flex justify-end space-x-2">
                <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-150 text-sm">ì·¨ì†Œ</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150 text-sm">ì‚­ì œ ì‹¤í–‰</button>
            </div>
        </div>
    </div>


    <script>
        // ì§ì› ë°ì´í„° ë°°ì—´ (ê°€ìƒì˜ ì˜êµ¬ ì €ì¥ì†Œ ì—­í• )
        const employeeData = [
            { name: "ê¹€ìœ¤ì§€", id: "busan001", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ì´ì •í•˜", id: "busan002", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "ë³€ì •ì¸", id: "busan003", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ë…¸ë¯¸ë¼", id: "busan004", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ê°•ì´ì€", id: "busan005", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "í•œì •ì„", id: "busan006", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "ê¹€ë‚˜í˜„", id: "busan007", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ìœ ì§€ìœ¤", id: "busan008", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "ì—†ìŒ", id: "busan009", status: "ì‹ ì²­ ì—†ìŒ", leoxStatus: "ë¯¸ì¡´ì¬", history: [] },
            { name: "ë°•ì˜ì›…", id: "busan010", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "í•œì •ì„", id: "busan011", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "ìœ ì§€ìœ¤", id: "busan012", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ì˜¤ì¬ìš©", id: "busan013", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "ìµœí˜„ì§„", id: "busan014", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ë°•í˜œë¯¼", id: "busan015", status: "í‡´ì‚¬", leoxStatus: "ì‚­ì œ", history: [] },
            { name: "í—ˆë‹¤ì˜", id: "busan016", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ë°•ë‹¤ì€", id: "busan017", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ì—†ìŒ", id: "busan018", status: "ì‹ ì²­ ì—†ìŒ", leoxStatus: "ë¯¸ì¡´ì¬", history: [] },
            { name: "ì—†ìŒ", id: "busan019", status: "ì‹ ì²­ ì—†ìŒ", leoxStatus: "ë¯¸ì¡´ì¬", history: [] },
            { name: "ì—†ìŒ", id: "busan020", status: "ì‹ ì²­ ì—†ìŒ", leoxStatus: "ë¯¸ì¡´ì¬", history: [] },
            { name: "ì—†ìŒ", id: "busan021", status: "ì‹ ì²­ ì—†ìŒ", leoxStatus: "ë¯¸ì¡´ì¬", history: [] },
            { name: "ê³ ì„±ì", id: "busan022", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
            { name: "ì´ìˆ˜ì§„", id: "busan023", status: "ê·¼ë¬´ì¤‘", leoxStatus: "ì •ìƒ", history: [] },
        ];

        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í–‰ì˜ IDë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let editingId = null;
        // ì‚­ì œ í™•ì¸ ì¤‘ì¸ IDë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let idToDelete = null; 
        
        // --- ìˆ˜ì • ëª¨ë“œ ë° ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ ---
        const CORRECT_PASSWORD = 'leox1234'; // ë°ëª¨ìš© ë¹„ë°€ë²ˆí˜¸
        let isEditModeEnabled = false; // ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™”
        
        // ê·¼ë¬´ì—¬ë¶€ ë° LeoX ìƒíƒœ ì˜µì…˜
        const statusOptions = ['ê·¼ë¬´ì¤‘', 'í‡´ì‚¬', 'ì‹ ì²­ ì—†ìŒ', 'ì‹ ê·œ ë“±ë¡'];
        const leoxOptions = ['ì •ìƒ', 'ì‚­ì œ', 'ë¯¸ì¡´ì¬'];
        
        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        /**
         * ìƒíƒœ í…ìŠ¤íŠ¸ì— ë”°ë¼ ê¸°ë³¸ ìƒ‰ìƒ ê·¸ë£¹ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function getStatusGroup(statusText) {
            switch (statusText) {
                case 'ê·¼ë¬´ì¤‘':
                case 'ì •ìƒ':
                    return 'green';
                case 'í‡´ì‚¬':
                case 'ì‚­ì œ':
                case 'íœ´ì§':
                case 'ì¼ì‹œ ì •ì§€':
                    return 'red';
                case 'ì‹ ê·œ ë“±ë¡':
                    return 'yellow'; // ì‹ ê·œ ë“±ë¡ì€ íŠ¹ë³„íˆ ë…¸ë€ìƒ‰ìœ¼ë¡œ í‘œì‹œí•˜ì—¬ ëˆˆì— ë„ê²Œ í•©ë‹ˆë‹¤.
                case 'ì‹ ì²­ ì—†ìŒ':
                case 'ë¯¸ì¡´ì¬':
                default:
                    return 'gray';
            }
        }

        /**
         * ìƒíƒœ ê·¸ë£¹ì— ë”°ë¼ ë±ƒì§€ì™€ í–‰ ë°°ê²½ìƒ‰ í´ë˜ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * ëª¨ë“  í–‰ì— ì¡°ê±´ë¶€ ë°°ê²½ìƒ‰ì„ ì ìš©í•˜ë„ë¡ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
         */
        function getStatusClasses(statusGroup) {
            switch (statusGroup) {
                case 'green': // ê·¼ë¬´ì¤‘, ì •ìƒ (í™œì„±)
                    return { badgeBg: 'bg-blue-200', badgeText: 'text-blue-800', rowBg: 'bg-blue-50/70', hoverBg: 'hover:bg-blue-100' };
                case 'red': // í‡´ì‚¬, ì‚­ì œ (ë¹„í™œì„±/ì‚­ì œ)
                    return { badgeBg: 'bg-red-200', badgeText: 'text-red-700', rowBg: 'bg-red-100/70', hoverBg: 'hover:bg-red-200' };
                case 'yellow': // ì‹ ê·œ ë“±ë¡ (ì„ì‹œ ìƒíƒœ)
                    return { badgeBg: 'bg-yellow-200', badgeText: 'text-yellow-800', rowBg: 'bg-yellow-50/70', hoverBg: 'hover:bg-yellow-100' };
                case 'gray': // ì‹ ì²­ ì—†ìŒ, ë¯¸ì¡´ì¬ (ì¤‘ë¦½)
                default:
                    return { badgeBg: 'bg-gray-200', badgeText: 'text-gray-600', rowBg: 'bg-gray-50/70', hoverBg: 'hover:bg-gray-100' };
            }
        }

        /**
         * ìƒíƒœ í…ìŠ¤íŠ¸ë¡œ ë±ƒì§€ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function createStatusBadge(statusText) {
            const statusGroup = getStatusGroup(statusText);
            const { badgeBg, badgeText } = getStatusClasses(statusGroup);
            return `<span class="status-badge ${badgeBg} ${badgeText}">${statusText}</span>`;
        }

        /**
         * ë³€ê²½ ì´ë ¥ ìœ í˜• ë¬¸ìì—´ì—ì„œ ì´ë¦„ ë¶€ë¶„ì„ ì°¾ì•„ ë¶‰ì€ìƒ‰ìœ¼ë¡œ ê°•ì¡°í•©ë‹ˆë‹¤.
         */
        function highlightNameInHistoryType(typeString) {
            const colorClass = 'text-red-600 font-bold';
            let result = typeString;

            // Pattern 1: [Name]ë‹˜ (e.g., "ì´ì •í•˜ë‹˜ í‡´ì‚¬...")
            // Capture group 1: [Name] (Korean name characters)
            // Capture group 2: ë‹˜
            result = result.replace(
                /([ê°€-í£]+)(ë‹˜)/g, 
                (match, name, suffix) => `<span class="${colorClass}">${name}</span>${suffix}`
            );

            // Pattern 2: ([Name]) or (ì´ì „ ì‚¬ìš©ì: [Name]) (e.g., "ID ì¬í• ë‹¹ ë° ì‹ ê·œ ë“±ë¡ (ê¹€ë‚˜í˜„)")
            // Capture group 1: Everything inside the parenthesis
            result = result.replace(
                /\((.*?)\)/g, 
                (match) => {
                    // Replace the Korean name part inside the parenthesis with the colored span
                    return match.replace(
                        /([ê°€-í£]+)/g, 
                        (nameMatch) => `<span class="${colorClass}">${nameMatch}</span>`
                    );
                }
            );
            
            return result;
        }

        /**
         * ë³€ê²½ ì´ë ¥ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ HTML ëª©ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function createHistoryDetails(history) {
            if (!history || history.length === 0) {
                return '<p class="text-gray-500 italic p-4">ë“±ë¡ëœ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (ê°€ì¥ ìµœê·¼ í•­ëª©ì´ ìœ„ë¡œ)
            const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));

            const listItems = sortedHistory.map(item => {
                let detailsHtml = '';
                
                if (item.changes) {
                    detailsHtml = '<div class="mt-2 text-sm text-gray-700 space-y-1 bg-gray-50 p-3 rounded-lg border border-gray-200">';
                    detailsHtml += '<p class="font-bold text-blue-700">ì£¼ìš” ë³€ê²½ ì‚¬í•­:</p>';

                    const fieldMap = { id: 'ì•„ì´ë””', name: 'ì´ë¦„', status: 'ê·¼ë¬´ì—¬ë¶€', leoxStatus: 'LeoX ìƒíƒœ' };
                    
                    // ë³€ê²½ëœ í•„ë“œë“¤ì„ ìˆœíšŒí•˜ë©° ì´ì „ ê°’ -> ìƒˆ ê°’ì„ í‘œì‹œ
                    Object.keys(item.changes).forEach(field => {
                        const fieldName = fieldMap[field] || field;
                        const change = item.changes[field];
                        detailsHtml += `<p><span class="font-semibold">${fieldName}:</span> <span class="text-red-500">${change.from}</span> &rarr; <span class="text-green-600 font-bold">${change.to}</span></p>`;
                    });
                    detailsHtml += '</div>';
                }
                
                detailsHtml += `<p class="text-sm text-gray-600 mt-2">${item.details}</p>`;

                // highlightNameInHistoryType í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ type ë¬¸ìì—´ì˜ ì´ë¦„ ë¶€ë¶„ì„ ê°•ì¡°í•©ë‹ˆë‹¤.
                const highlightedType = highlightNameInHistoryType(item.type);

                return `
                    <li class="p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-800">${highlightedType}</span>
                            <span class="text-xs text-gray-500">${item.date}</span>
                        </div>
                        ${detailsHtml}
                    </li>
                `;
            }).join('');

            return `
                <div class="p-6">
                    <h4 class="text-lg font-bold mb-4 text-blue-800 border-b pb-2">ë³€ê²½ ì´ë ¥ (${history.length}ê±´)</h4>
                    <ul class="space-y-4 history-list">
                        ${listItems}
                    </ul>
                </div>
            `;
        }
        
        // --- UI ì—…ë°ì´íŠ¸ ë° ì•¡ì…˜ í•¨ìˆ˜ ---

        /**
         * ìˆ˜ì • ëª¨ë“œ UI (ë²„íŠ¼ í…ìŠ¤íŠ¸, ìŠ¤íƒ€ì¼, ì‹ ê·œ ID ë²„íŠ¼ í™œì„±í™”)ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateEditModeUI() {
            const toggleBtn = document.getElementById('toggleEditModeBtn');
            const statusSpan = document.getElementById('editModeStatus');
            const newIdBtn = document.getElementById('addNewIdBtn'); // ì‹ ê·œ ID ë²„íŠ¼
            
            if (isEditModeEnabled) {
                // ìˆ˜ì • ë²„íŠ¼ UI ë³€ê²½
                statusSpan.textContent = 'ìˆ˜ì • í™œì„±í™” (í´ë¦­í•˜ì—¬ ë¹„í™œì„±í™”)';
                toggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                // ì‹ ê·œ ID ë²„íŠ¼ í™œì„±í™”
                newIdBtn.disabled = false;
                newIdBtn.classList.remove('disabled-btn', 'opacity-50', 'cursor-not-allowed', 'shadow-none');
                newIdBtn.classList.add('shadow-lg', 'hover:bg-teal-600');

            } else {
                // ìˆ˜ì • ë²„íŠ¼ UI ë³€ê²½
                statusSpan.textContent = 'ìˆ˜ì • ë¹„í™œì„±í™”';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleBtn.classList.add('bg-red-500', 'hover:bg-red-600');

                // ì‹ ê·œ ID ë²„íŠ¼ ë¹„í™œì„±í™”
                newIdBtn.disabled = true;
                newIdBtn.classList.add('disabled-btn', 'opacity-50', 'cursor-not-allowed', 'shadow-none');
                newIdBtn.classList.remove('shadow-lg', 'hover:bg-teal-600');
            }
        }
        
        /**
         * ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordInput').focus();
        }

        /**
         * ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ì„ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }
        
        /**
         * ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • ëª¨ë“œë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
         */
        function checkPasswordAndActivate(password) {
            if (password === CORRECT_PASSWORD) {
                isEditModeEnabled = true;
                hidePasswordModal();
                updateEditModeUI();
                filterTable(); // ë²„íŠ¼ í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œë¥¼ ìœ„í•´ í…Œì´ë¸” ë¦¬ë Œë”ë§
                console.log("ìˆ˜ì • ëª¨ë“œê°€ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                document.getElementById('passwordError').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        /**
         * ìˆ˜ì • ëª¨ë“œ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleEditModeActivation() {
            if (isEditModeEnabled) {
                // ë¹„í™œì„±í™” ì²˜ë¦¬ (ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ë°”ë¡œ ê°€ëŠ¥)
                isEditModeEnabled = false;
                updateEditModeUI();
                filterTable();
                console.log("ìˆ˜ì • ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                // í™œì„±í™” ì²˜ë¦¬ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
                showPasswordModal();
            }
        }

        /**
         * ë‹¤ìŒ ìˆœë²ˆì˜ ID (busanXXX)ë¥¼ ê³„ì‚°í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function getNextEmployeeId() {
            let maxNum = 0;
            // ëª¨ë“  IDì—ì„œ ìˆ«ì ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ìµœëŒ€ê°’ì„ ì°¾ìŠµë‹ˆë‹¤.
            employeeData.forEach(data => {
                const match = data.id.match(/^busan(\d+)$/);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > maxNum) {
                        maxNum = num;
                    }
                }
            });

            const nextNum = maxNum + 1;
            // ìˆ«ìë¥¼ 3ìë¦¬ ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤ (ì˜ˆ: 1 -> "001", 24 -> "024")
            const nextIdSuffix = String(nextNum).padStart(3, '0');
            return `busan${nextIdSuffix}`;
        }

        /**
         * ì‹ ê·œ IDë¥¼ ìƒì„±í•˜ê³  í…Œì´ë¸”ì— ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function addNewEmployee() {
            // --- GUARD: Check if edit mode is enabled ---
            if (!isEditModeEnabled) {
                console.error("ìˆ˜ì • ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì–´ IDë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë²„íŠ¼ì„ í™œì„±í™”í•´ì£¼ì„¸ìš”.");
                return;
            }

            const newId = getNextEmployeeId();
            const newEmployee = {
                id: newId,
                name: "ì‹ ê·œ ë“±ë¡",
                status: "ì‹ ê·œ ë“±ë¡", // ì‹ ê·œ ë“±ë¡ ìƒíƒœë¡œ ì„¤ì •í•˜ì—¬ ëˆˆì— ë„ê²Œ í•¨
                leoxStatus: "ë¯¸ì¡´ì¬",
                history: [{ date: new Date().toISOString().substring(0, 10), type: "ì‹ ê·œ ID ìƒì„±", details: `ID ${newId}ê°€ ìƒì„±ë˜ì—ˆìœ¼ë©°, ê¸°ë³¸ ê°’ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.` }]
            };

            employeeData.push(newEmployee);
            console.log(`ì‹ ê·œ ID ${newId}ê°€ ìƒì„± ë° ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // í•„í„°ë§ ë° í…Œì´ë¸” ë¦¬ë Œë”ë§ (ì‹ ê·œ í–‰ í‘œì‹œ)
            filterTable(); 
            
            // ì‹ ê·œ í–‰ì„ ì¦‰ì‹œ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜ (í¸ì˜ë¥¼ ìœ„í•´)
            setTimeout(() => {
                const newRow = document.querySelector(`.data-row[data-id="${newId}"]`);
                if (newRow) {
                    toggleEditMode(null, newId);
                }
            }, 100); 
        }


        /**
         * ID ì‚­ì œ í™•ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function confirmAndDelete(event, employeeId, employeeName) {
            if (event) event.stopPropagation();

            if (!isEditModeEnabled) {
                console.error("ìˆ˜ì • ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì–´ IDë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // 1. ì‚­ì œ ëŒ€ìƒ ID ì €ì¥
            idToDelete = employeeId;
            
            // 2. ë©”ì‹œì§€ ì„¤ì •
            const msgElement = document.getElementById('deleteConfirmMessage');
            msgElement.innerHTML = `ì •ë§ <span class="font-bold text-red-500">${employeeName}</span> ë‹˜ì˜ ID <span class="font-bold">${employeeId}</span> ë¥¼ <span class="font-extrabold">ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œ</span>í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            
            // 3. ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('deleteConfirmationModal').classList.remove('hidden');
        }

        /**
         * ID ì‚­ì œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
         */
        function deleteEmployee() {
            if (!idToDelete) return;

            // 1. ë°ì´í„°ì—ì„œ í•´ë‹¹ ID ì œê±°
            const index = employeeData.findIndex(d => d.id === idToDelete);
            const deletedEmployeeName = employeeData[index]?.name || idToDelete;

            if (index > -1) {
                employeeData.splice(index, 1);
                console.log(`ID ${idToDelete} (${deletedEmployeeName}) ì‚­ì œ ì™„ë£Œ.`);
            } else {
                console.error(`ID ${idToDelete}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }

            // 2. UI ì—…ë°ì´íŠ¸
            filterTable();
            
            // 3. ëª¨ë‹¬ ë‹«ê¸° ë° ì´ˆê¸°í™”
            document.getElementById('deleteConfirmationModal').classList.add('hidden');
            idToDelete = null;

            // Optional: Show a temporary success message in the console
            console.log(`[ì„±ê³µ] ID ${idToDelete}ê°€ ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }


        /**
         * ìƒíƒœ í•„í„° ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateStatusButtonStyles(selectedStatus) {
            document.querySelectorAll('.status-btn').forEach(btn => {
                if (btn.getAttribute('data-status') === selectedStatus) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-none');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-none');
                }
            });
        }
        
        /**
         * ëª¨ë“  ì§ì› ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸” ë³¸ë¬¸ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderTable(dataToRender = employeeData) {
            const tbody = document.getElementById('employeeTableBody');
            const noResults = document.getElementById('noResults');
            if (!tbody || !noResults) return;

            // ID ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‹ ê·œ ë“±ë¡ëœ í•­ëª©ì´ ë§ˆì§€ë§‰ì— ì˜¤ë„ë¡ í•©ë‹ˆë‹¤.
            dataToRender.sort((a, b) => a.id.localeCompare(b.id));

            if (dataToRender.length === 0) {
                tbody.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            
            const htmlContent = dataToRender.map(data => {
                const statusGroup = getStatusGroup(data.status);
                // rowBgì™€ hoverBgë¥¼ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const { rowBg, hoverBg } = getStatusClasses(statusGroup); 
                const hasHistory = data.history && data.history.length > 0;
                
                const isEditing = data.id === editingId;

                // ì•¡ì…˜/ì´ë ¥ ì…€ì˜ ë‚´ìš©
                let actionContent = '';
                if (isEditing) {
                    actionContent = `
                        <div class="flex flex-col space-y-1">
                            <button onclick="saveChanges(event, '${data.id}')" class="text-xs font-bold py-1 px-2 rounded-md bg-green-500 text-white hover:bg-green-600 transition duration-150 shadow-md">ì €ì¥</button>
                            <button onclick="cancelEdit(event, '${data.id}')" class="text-xs font-bold py-1 px-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">ì·¨ì†Œ</button>
                        </div>
                    `;
                } else {
                    // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë° ì´ë ¥ ì•„ì´ì½˜
                    const toggleIcon = hasHistory ? '<svg class="w-4 h-4 text-gray-500 toggle-icon transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : '<span class="text-gray-400">-</span>';
                    
                    let editButtonHtml = '';
                    let deleteButtonHtml = '';

                    if (isEditModeEnabled) {
                        editButtonHtml = `<button onclick="toggleEditMode(event, '${data.id}')" class="text-xs font-bold py-1 px-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 transition duration-150 shadow-md">ìˆ˜ì •</button>`;
                        deleteButtonHtml = `<button onclick="confirmAndDelete(event, '${data.id}', '${data.name}')" class="text-xs font-bold py-1 px-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">ì‚­ì œ</button>`;
                    }
                    
                    // ì•¡ì…˜/ì´ë ¥ ì…€ì˜ ë ˆì´ì•„ì›ƒ ê²°ì •
                    if (isEditModeEnabled) {
                        actionContent = `
                            <div class="flex flex-col space-y-1 items-center">
                                <div class="flex space-x-1 w-full justify-center">
                                    ${editButtonHtml}
                                    ${deleteButtonHtml}
                                </div>
                                ${hasHistory ? `<div class="mt-1">${toggleIcon}</div>` : ''}
                            </div>
                        `;
                    } else if (!isEditModeEnabled && hasHistory) {
                        actionContent = `
                            <div class="flex items-center justify-center space-x-2">
                                ${toggleIcon}
                            </div>
                        `;
                    } else { // !isEditModeEnabled && !hasHistory
                        actionContent = `<span class="text-gray-400">-</span>`;
                    }
                }
                
                // ê·¼ë¬´ì—¬ë¶€ Select ì˜µì…˜ ìƒì„±
                const statusSelectOptions = statusOptions.map(opt => 
                    `<option value="${opt}" ${data.status === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');

                // LeoX ìƒíƒœ Select ì˜µì…˜ ìƒì„±
                const leoxSelectOptions = leoxOptions.map(opt => 
                    `<option value="${opt}" ${data.leoxStatus === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');


                // 1. ë©”ì¸ ë°ì´í„° í–‰: ë™ì ìœ¼ë¡œ rowBgì™€ hoverBg í´ë˜ìŠ¤ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
                const mainRow = `
                    <tr class="data-row ${isEditing ? 'editing bg-yellow-100 hover:bg-yellow-100' : rowBg + ' ' + hoverBg}" data-id="${data.id}" data-status="${data.status}" data-leox-status="${data.leoxStatus}" data-name="${data.name}">
                        <!-- ì•„ì´ë”” (í¸ì§‘ ë¶ˆê°€) -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center font-semibold">${data.id}</td>
                        
                        <!-- ì´ë¦„ (í¸ì§‘ ê°€ëŠ¥) -->
                        <td class="px-6 py-4 whitespace-nowrap text-center" data-field="name">
                            <span class="display-value ${isEditing ? 'hidden' : ''}">${data.name}</span>
                            <input type="text" value="${data.name}" class="edit-input ${isEditing ? '' : 'hidden'}" data-old-value="${data.name}">
                        </td>
                        
                        <!-- ê·¼ë¬´ì—¬ë¶€ (í¸ì§‘ ê°€ëŠ¥) -->
                        <td class="px-6 py-4 whitespace-nowrap text-center" data-field="status">
                            <span class="display-value ${isEditing ? 'hidden' : ''}">${createStatusBadge(data.status)}</span>
                            <select class="edit-select ${isEditing ? '' : 'hidden'}" data-old-value="${data.status}" data-field-name="status">
                                ${statusSelectOptions}
                            </select>
                        </td>
                        
                        <!-- LeoX ìƒíƒœ (í¸ì§‘ ê°€ëŠ¥) -->
                        <td class="px-6 py-4 whitespace-nowrap text-center" data-field="leoxStatus">
                            <span class="display-value ${isEditing ? 'hidden' : ''}">${createStatusBadge(data.leoxStatus)}</span>
                            <select class="edit-select ${isEditing ? '' : 'hidden'}" data-old-value="${data.leoxStatus}" data-field-name="leoxStatus">
                                ${leoxSelectOptions}
                            </select>
                        </td>
                        
                        <!-- ì•¡ì…˜/ì´ë ¥ ë²„íŠ¼ ë° ì•„ì´ì½˜ -->
                        <td class="px-3 py-4 text-center data-action" onclick="handleActionOrHistory(event, '${data.id}', ${hasHistory})">
                            ${actionContent}
                        </td>
                    </tr>
                `;

                // 2. ë³€ê²½ ì´ë ¥ ìƒì„¸ í–‰ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
                const historyRow = `
                    <tr class="history-row" data-history-id="${data.id}">
                        <td colspan="5" class="p-0 border-b border-gray-200">
                            <div class="overflow-hidden transition-all duration-300 ease-in-out max-h-0">
                                ${createHistoryDetails(data.history)}
                            </div>
                        </td>
                    </tr>
                `;

                return mainRow + historyRow;
            }).join('');

            tbody.innerHTML = htmlContent;
        }

        /**
         * ì´ë ¥ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì´ë ¥ ì„¹ì…˜ì˜ ê°€ì‹œì„±ì„ í† ê¸€í•©ë‹ˆë‹¤.
         * ì•¡ì…˜ ë²„íŠ¼ê³¼ ì´ë ¥ ì•„ì´ì½˜ í´ë¦­ì„ ë¶„ë¦¬ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        function handleActionOrHistory(event, employeeId, hasHistory) {
            // í¸ì§‘ ì¤‘ì¸ ìƒíƒœë¼ë©´ ì´ë ¥ í† ê¸€ì„ ë§‰ìŠµë‹ˆë‹¤.
            if (editingId) return;

            // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì´ë ¥ í† ê¸€ì„ ë¬´ì‹œí•©ë‹ˆë‹¤. 
            if (event && event.target.closest('button')) {
                return;
            }
            
            // ì´ë ¥ì´ ì—†ëŠ” ê²½ìš° í† ê¸€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            if (!hasHistory) return;

            const row = document.querySelector(`.data-row[data-id="${employeeId}"]`);
            const historyIcon = row ? row.querySelector('.toggle-icon') : null;
            if (row && historyIcon) {
                toggleHistoryDetails(employeeId, row, historyIcon);
            }
        }

        /**
         * ì´ë ¥ ìƒì„¸ ì •ë³´ë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleHistoryDetails(employeeId, row, icon) {
            const tbody = document.getElementById('employeeTableBody');
            const historyRow = tbody.querySelector(`tr[data-history-id="${employeeId}"]`);
            if (!historyRow) return;

            const detailContent = historyRow.querySelector('div');
            const isCurrentlyOpen = historyRow.style.display === 'table-row';
            
            // í˜„ì¬ í–‰ì˜ ì›ë˜ ë°°ê²½ìƒ‰ í´ë˜ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const statusGroup = row.getAttribute('data-status') ? getStatusGroup(row.getAttribute('data-status')) : 'gray';
            const { rowBg, hoverBg } = getStatusClasses(statusGroup);


            // ëª¨ë“  ì—´ë¦° ì´ë ¥ í–‰ ë‹«ê¸°
            tbody.querySelectorAll('.history-row').forEach(tr => {
                const relatedRowId = tr.getAttribute('data-history-id');
                const relatedRow = tbody.querySelector(`.data-row[data-id="${relatedRowId}"]`);
                const relatedIcon = relatedRow ? relatedRow.querySelector('.toggle-icon') : null;
                
                // ë‹«ì„ í–‰ì˜ ì›ë˜ ë°°ê²½ìƒ‰ì„ ë‹¤ì‹œ ê³„ì‚°í•©ë‹ˆë‹¤.
                const relatedStatusGroup = relatedRow.getAttribute('data-status') ? getStatusGroup(relatedRow.getAttribute('data-status')) : 'gray';
                const { rowBg: relatedRowBg } = getStatusClasses(relatedStatusGroup); 

                if (tr.style.display === 'table-row') {
                    tr.style.display = 'none';
                    tr.querySelector('div').style.maxHeight = '0';
                    if (relatedRow) {
                        // ë‹«ì„ ë•Œ ì›ë˜ì˜ ë°°ê²½ìƒ‰ìœ¼ë¡œ ë³µì› (ë‹¨, editing ì¤‘ì¸ í–‰ì˜ ìƒ‰ìƒì€ ë³µì›í•˜ì§€ ì•ŠìŒ)
                        if (!relatedRow.classList.contains('editing')) {
                             // ê¸°ì¡´ì— ì„ì‹œë¡œ ì¶”ê°€í–ˆë˜ bg-blue-100 í´ë˜ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
                             relatedRow.classList.remove('bg-blue-100');
                             // ì›ë˜ì˜ ì¡°ê±´ë¶€ ë°°ê²½ìƒ‰ì„ ë‹¤ì‹œ ì¶”ê°€í•©ë‹ˆë‹¤.
                             relatedRow.classList.add(relatedRowBg);
                        }
                    }
                    if (relatedIcon) relatedIcon.style.transform = 'rotate(0deg)';
                }
            });
            
            // í˜„ì¬ í–‰ ì—´ê¸°/ë‹«ê¸° ì²˜ë¦¬
            if (isCurrentlyOpen) {
                // ì´ë¯¸ ë‹«í˜ ì²˜ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ëª¨ë“  í–‰ ë‹«ê¸° ë¡œì§ì—ì„œ ì²˜ë¦¬ë¨)
            } else {
                // ë‹«í˜€ ìˆì—ˆìœ¼ë¯€ë¡œ í˜„ì¬ í–‰ ì—´ê¸°
                historyRow.style.display = 'table-row';
                setTimeout(() => {
                    detailContent.style.maxHeight = `${detailContent.scrollHeight + 10}px`; 
                }, 50);

                if (icon) icon.style.transform = 'rotate(90deg)';
                
                // ë°°ê²½ìƒ‰ ë³€ê²½: ì›ë˜ì˜ ì¡°ê±´ë¶€ ë°°ê²½ìƒ‰ì„ ì œê±°í•˜ê³ , ì´ë ¥ ì—´ëŒ ì¤‘ì¸ ë°°ê²½ìƒ‰ì„ ì ìš©í•©ë‹ˆë‹¤.
                row.classList.remove(rowBg);
                row.classList.add('bg-blue-100'); // ì´ë ¥ ì—´ëŒ ì¤‘ì¸ í–‰ì€ íŒŒë€ìƒ‰ ë°°ê²½ìœ¼ë¡œ í‘œì‹œ
            }
        }

        /**
         * í…Œì´ë¸” í–‰ì„ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.
         */
        function toggleEditMode(event, employeeId) {
            // eventê°€ ìˆì„ ê²½ìš°ì—ë§Œ stopPropagation í˜¸ì¶œ (addNewEmployeeì—ì„œ nullë¡œ í˜¸ì¶œë  ìˆ˜ ìˆìŒ)
            if (event) {
                event.stopPropagation(); 
            }

            if (!isEditModeEnabled) {
                console.warn("[ê²½ê³ ] ìˆ˜ì • ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ í™œì„±í™”í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (editingId && editingId !== employeeId) {
                console.warn(`[ê²½ê³ ] ID ${editingId}ì˜ í¸ì§‘ì„ ë¨¼ì € ì €ì¥í•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”.`);
                return;
            }
            
            const row = document.querySelector(`.data-row[data-id="${employeeId}"]`);
            if (!row) return;

            // ì´ë ¥ í–‰ì´ ì—´ë ¤ ìˆë‹¤ë©´ ë‹«ìŠµë‹ˆë‹¤.
            const historyIcon = row.querySelector('.toggle-icon');
            if (row.classList.contains('bg-blue-100')) {
                toggleHistoryDetails(employeeId, row, historyIcon);
            }
            
            // í¸ì§‘ ëª¨ë“œ ì‹œì‘
            editingId = employeeId;
            row.classList.add('editing', 'bg-yellow-100', 'hover:bg-yellow-100');
            
            // í˜„ì¬ í–‰ì˜ ì›ë˜ ë°°ê²½ìƒ‰ì„ ê°€ì ¸ì™€ ì œê±°í•©ë‹ˆë‹¤.
            const statusGroup = getStatusGroup(row.getAttribute('data-status'));
            const { rowBg, hoverBg } = getStatusClasses(statusGroup);
            row.classList.remove(rowBg, hoverBg);


            // 1. ì…ë ¥ í•„ë“œ ë³´ì´ê¸° / ë””ìŠ¤í”Œë ˆì´ ê°’ ìˆ¨ê¸°ê¸°
            row.querySelectorAll('[data-field]').forEach(cell => {
                cell.querySelector('.display-value').classList.add('hidden');
                const input = cell.querySelector('.edit-input') || cell.querySelector('.edit-select');
                if (input) input.classList.remove('hidden');
            });
            
            // 2. ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì €ì¥/ì·¨ì†Œ)
            const actionCell = row.querySelector('.data-action');
            actionCell.innerHTML = `
                <div class="flex flex-col space-y-1">
                    <button onclick="saveChanges(event, '${employeeId}')" class="text-xs font-bold py-1 px-2 rounded-md bg-green-500 text-white hover:bg-green-600 transition duration-150 shadow-md">ì €ì¥</button>
                    <button onclick="cancelEdit(event, '${employeeId}')" class="text-xs font-bold py-1 px-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">ì·¨ì†Œ</button>
                </div>
            `;
            // ì•¡ì…˜ ì…€ í´ë¦­ ì‹œ ì´ë ¥ í† ê¸€ ì´ë²¤íŠ¸ ë°©ì§€ (ë²„íŠ¼ í´ë¦­ë§Œ í—ˆìš©)
            actionCell.onclick = (e) => e.stopPropagation();
        }

        /**
         * ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ê³  ìƒˆ ì´ë ¥ì„ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function saveChanges(event, employeeId) {
            event.stopPropagation();
            
            const row = document.querySelector(`.data-row[data-id="${employeeId}"]`);
            if (!row) return;
            
            const employee = employeeData.find(d => d.id === employeeId);
            if (!employee) return;

            const newValues = {};
            const changes = {};

            let hasChanges = false;
            
            // 1. ìƒˆ ê°’ ìˆ˜ì§‘ ë° ë³€ê²½ ì‚¬í•­ í™•ì¸
            row.querySelectorAll('[data-field]').forEach(cell => {
                const fieldName = cell.getAttribute('data-field');
                const input = cell.querySelector('.edit-input') || cell.querySelector('.edit-select');
                
                if (input) {
                    const newValue = input.value.trim();
                    const oldValue = input.getAttribute('data-old-value').trim();
                    
                    if (newValue !== oldValue) {
                        hasChanges = true;
                        newValues[fieldName] = newValue;

                        changes[fieldName] = { from: oldValue, to: newValue };
                        
                        // ë³€ê²½ëœ ê°’ìœ¼ë¡œ data-old-value ì—…ë°ì´íŠ¸
                        input.setAttribute('data-old-value', newValue);
                    }
                }
            });

            if (!hasChanges) {
                console.log(`ID ${employeeId}: ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. í¸ì§‘ ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.`);
                cancelEdit(event, employeeId);
                return;
            }

            // 2. ë°ì´í„° ì—…ë°ì´íŠ¸ ë° Type Description ê²°ì •
            const employeeName = newValues.name || employee.name; // ìˆ˜ì •ëœ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ì´ë¦„ ì‚¬ìš©
            let typeDescription = `ì§ì› ìƒíƒœ ë³€ê²½ (${employeeName})`;
            
            if (changes.status && changes.status.to === 'í‡´ì‚¬' && changes.leoxStatus && changes.leoxStatus.to === 'ì‚­ì œ') {
                 // í‡´ì‚¬ ì²˜ë¦¬ ì‹œ ì´ë¦„ ëª…ì‹œ
                 typeDescription = `${employeeName}ë‹˜ í‡´ì‚¬ ë° ID ì‚­ì œ ì²˜ë¦¬`;
            } else if (changes.status && changes.status.to === 'ì‹ ì²­ ì—†ìŒ' && changes.leoxStatus && changes.leoxStatus.to === 'ë¯¸ì¡´ì¬' && (changes.name && changes.name.to === 'ì—†ìŒ')) {
                 // ID ì´ˆê¸°í™” ì‹œ ì´ì „ ì‚¬ìš©ì ì´ë¦„ ëª…ì‹œ (ì´ë¦„ ë³€ê²½ì´ ìˆì—ˆì„ ê²½ìš°)
                 const formerName = changes.name ? changes.name.from : employee.name;
                 typeDescription = `ID ì´ˆê¸°í™” (ì´ì „ ì‚¬ìš©ì: ${formerName})`;
            } else if (changes.status && changes.status.from === 'ì‹ ê·œ ë“±ë¡') {
                 // ì‹ ê·œ ë“±ë¡ í•­ëª©ì˜ ì²« ì €ì¥
                 typeDescription = `ì‹ ê·œ ë“±ë¡ í•­ëª© ìµœì¢… ì €ì¥ (${employeeName})`;
            } else if (changes.status && changes.status.from === 'ì‹ ì²­ ì—†ìŒ' && changes.name && changes.name.from === 'ì—†ìŒ') {
                 // ì¬í• ë‹¹ ì‹œ ì‹ ê·œ ì‚¬ìš©ì ì´ë¦„ ëª…ì‹œ
                 typeDescription = `ID ì¬í• ë‹¹ ë° ì‹ ê·œ ë“±ë¡ (${employeeName})`;
            } else if (changes.name) {
                 // ì´ë¦„ì´ í¬í•¨ëœ ì¼ë°˜ ë³€ê²½
                 typeDescription = `ì§ì› ì´ë¦„ ë° ìƒíƒœ ë³€ê²½ (${employeeName})`;
            } else {
                 // ì´ë¦„ì´ í¬í•¨ë˜ì§€ ì•Šì€ ì¼ë°˜ ìƒíƒœ ë³€ê²½
                 typeDescription = `ì§ì› ìƒíƒœ ë³€ê²½ (${employeeName})`;
            }


            // 3. ìƒˆ ì´ë ¥ í•­ëª© ìƒì„±
            const newHistoryEntry = {
                date: new Date().toISOString().substring(0, 10),
                type: typeDescription,
                details: `${employeeName}ë‹˜ì˜ í˜„í™©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (${Object.keys(changes).length}ê°œ í•„ë“œ ë³€ê²½ë¨. ëŒ€ì‹œë³´ë“œ ìˆ˜ì • ê¸°ëŠ¥ ì‚¬ìš©)`,
                changes: changes,
            };

            // 4. ë©”ì¸ ë°ì´í„° ê°ì²´ì™€ ì´ë ¥ ë°°ì—´ ì—…ë°ì´íŠ¸
            Object.assign(employee, newValues); 
            employee.history.unshift(newHistoryEntry); 

            // 5. í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ ë° í…Œì´ë¸” ë¦¬ë Œë”ë§
            editingId = null;
            row.classList.remove('editing', 'bg-yellow-100', 'hover:bg-yellow-100');
            
            // í•„í„°ë§ ë° í…Œì´ë¸” ì „ì²´ ë¦¬ë Œë”ë§ (ë³€ê²½ ì´ë ¥ì„ ë°˜ì˜í•˜ê¸° ìœ„í•´ í•„ìˆ˜)
            filterTable(); 
        }

        /**
         * ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ì§€ ì•Šê³  í¸ì§‘ ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
         */
        function cancelEdit(event, employeeId) {
            if (event) event.stopPropagation();
            
            const row = document.querySelector(`.data-row[data-id="${employeeId}"]`);
            if (!row) return;

            // 1. ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸° / ë””ìŠ¤í”Œë ˆì´ ê°’ ë³´ì´ê¸°
            row.querySelectorAll('[data-field]').forEach(cell => {
                const input = cell.querySelector('.edit-input') || cell.querySelector('.edit-select');
                if (input) {
                    // ê°’ì€ old-valueë¡œ ë‹¤ì‹œ ì„¤ì •
                    input.value = input.getAttribute('data-old-value'); 
                    input.classList.add('hidden');
                }
                cell.querySelector('.display-value').classList.remove('hidden');
            });
            
            // 2. í¸ì§‘ ëª¨ë“œ í”Œë˜ê·¸ ë° ìŠ¤íƒ€ì¼ ì œê±°
            editingId = null;
            row.classList.remove('editing', 'bg-yellow-100', 'hover:bg-yellow-100');
            
            // 3. í…Œì´ë¸” ë¦¬ë Œë”ë§ (ì•¡ì…˜ ë²„íŠ¼ì„ ë‹¤ì‹œ 'ìˆ˜ì •'ìœ¼ë¡œ ë³€ê²½)
            filterTable();
        }


        // --- í•„í„°ë§ ë° ì´ˆê¸°í™” ë¡œì§ ---

        const statusFilter = document.getElementById('statusFilter'); // Hidden input
        const searchFilter = document.getElementById('searchFilter');

        const filterTable = () => {
            const selectedStatus = statusFilter.value;
            const searchQuery = searchFilter.value.toLowerCase().trim();

            const filteredData = employeeData.filter(data => {
                const statusMatch = (selectedStatus === 'ì „ì²´' || data.status === selectedStatus || (selectedStatus === 'ê·¼ë¬´ì¤‘' && data.status === 'ì‹ ê·œ ë“±ë¡')); // ì‹ ê·œ ë“±ë¡ë„ ê·¼ë¬´ì¤‘ìœ¼ë¡œ ê°„ì£¼
                const searchMatch = (
                    searchQuery === '' || 
                    data.name.toLowerCase().includes(searchQuery) || 
                    data.id.toLowerCase().includes(searchQuery)
                );
                return statusMatch && searchMatch;
            });

            // í•„í„°ë§ëœ ë°ì´í„°ë¡œ í…Œì´ë¸”ì„ ë‹¤ì‹œ ë Œë”ë§í•©ë‹ˆë‹¤.
            renderTable(filteredData);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // ì´ˆê¸° í…Œì´ë¸” ë Œë”ë§
            renderTable();
            
            // 1. ìƒíƒœ í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.querySelectorAll('.status-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const status = e.target.getAttribute('data-status');
                    document.getElementById('statusFilter').value = status; // Hidden input ì—…ë°ì´íŠ¸
                    filterTable();
                    updateStatusButtonStyles(status);
                });
            });

            // ì´ˆê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
            updateStatusButtonStyles(document.getElementById('statusFilter').value); 
            
            // 2. ê²€ìƒ‰ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            searchFilter.addEventListener('input', filterTable);

            // 3. ìˆ˜ì • ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('toggleEditModeBtn').addEventListener('click', toggleEditModeActivation);
            document.getElementById('addNewIdBtn').addEventListener('click', addNewEmployee);
            updateEditModeUI(); // ì´ˆê¸° UI ì„¤ì • (ë¹„í™œì„±í™” ìƒíƒœ)

            // 4. ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('cancelPasswordBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('submitPasswordBtn').addEventListener('click', () => {
                const password = document.getElementById('passwordInput').value;
                checkPasswordAndActivate(password);
            });
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const password = document.getElementById('passwordInput').value;
                    checkPasswordAndActivate(password);
                }
            });

            // 5. ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteConfirmationModal').classList.add('hidden');
                idToDelete = null;
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteEmployee);
        });
    </script>
</body>
</html>
